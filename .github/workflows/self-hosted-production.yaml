name: ğŸ  Self-Hosted Runner - Production Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-test-deploy:
    name: ğŸš€ Build, Test & Deploy
    runs-on: self-hosted
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Verify Environment
      run: |
        echo "ğŸ¯ Environment Verification:"
        echo "Kubernetes: $(kubectl cluster-info --short 2>/dev/null && echo 'âœ…' || echo 'âŒ')"
        echo "Docker: $(docker --version && echo 'âœ…' || echo 'âŒ')"

    - name: Build Docker Image
      run: |
        echo "ğŸ—ï¸ Building production microservice..."
        cd apps/sample-microservice
        docker build -t sample-microservice:prod .
        echo "âœ… Docker image built successfully"

    - name: Test Application
      run: |
        echo "ğŸ§ª Testing application health endpoints..."
        docker run -d --name test-container sample-microservice:prod
        sleep 10
        
        if docker exec test-container curl -s http://localhost:8090/health | grep -q healthy; then
          echo "âœ… Health endpoint working"
        else
          echo "âŒ Health check failed"
          docker logs test-container
          exit 1
        fi
        
        docker stop test-container
        docker rm test-container
        echo "âœ… Application testing completed"

    - name: Deploy to Kubernetes
      run: |
        echo "ğŸš€ Deploying to Kubernetes cluster..."
        kubectl create namespace guestbook --dry-run=client -o yaml | kubectl apply -f -
        kubectl apply -f manifests/base/deployment.yaml -n guestbook
        kubectl apply -f manifests/base/service.yaml -n guestbook
        echo "âœ… Application deployed to Kubernetes"

    - name: Verify Deployment
      run: |
        echo "ğŸ” Verifying deployment status..."
        kubectl rollout status deployment/sample-microservice -n guestbook --timeout=300s
        kubectl get pods -l app=sample-microservice -n guestbook -o wide
        
        kubectl run deployment-test --rm -i --restart=Never --image=curlimages/curl -- \
          -s http://sample-microservice.guestbook.svc.cluster.local/health | grep healthy
        echo "âœ… Deployment verification successful"

    - name: Production Success Report
      run: |
        echo "ğŸ‰ PRODUCTION DEPLOYMENT COMPLETE!"
        echo "=================================="
        kubectl get deployment sample-microservice -n guestbook
        kubectl get service sample-microservice -n guestbook
        kubectl get pods -l app=sample-microservice -n guestbook -o wide
        echo "ğŸš€ SELF-HOSTED RUNNER CI/CD PIPELINE - FULLY OPERATIONAL!"
